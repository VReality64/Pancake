<!DOCTYPE html>
<html>
<head>
	<meta charset="US-ASCII">
	<title>MIDI uploader</title>
    <script src="lib/midi/inc/jasmid/stream.js"></script>
    <script src="lib/midi/inc/jasmid/midifile.js"></script>
    <script src="lib/midi/inc/jasmid/replayer.js"></script>
    <script src="lib/midi/inc/Base64.js"></script>
    <script src="lib/midi/inc/base64binary.js"></script>
    <script src="lib/midi/js/MIDI/AudioDetect.js"></script>
    <script src="lib/midi/js/MIDI/LoadPlugin.js"></script>
    <script src="lib/midi/js/MIDI/Player.js"></script>
    <script src="lib/midi/js/MIDI/Plugin.js"></script>
    <script src="lib/midi/js/Window/DOMLoader.script.js"></script>
    <script src="lib/midi/js/Window/DOMLoader.XMLHttp.js"></script>
    <script src="lib/midi/js/Window/Event.js"></script>
<body>


midi file  <input type="file" id="files" name="file" placeholder="midi file"></input>
<button id="play" onclick="playstop(0);">Play</button>
<button id="stop" onclick="playstop(1);">Stop</button><br>
title  <input type="text" id="title" name="title"><br>
artist  <input type="text" id="artist" name="artist"><br>
owner  <input type="text" id="owner" name="owner"></br>
album art  <input type="file" id="albumArt" name="albumArt"><br>
description <input type="text" id="description" name="description"></br>
<button id="upload" onclick="upload();">Upload</button>
<!-- TODO -->
<script src="/lib/socket.io.js"> </script>
<script>

//setting up socket
var uploadSocket = io.connect('http://www.soundpancake.io');

uploadSocket.on('connect', function () {
	console.log('Connected !');
})

//setting up player
var player;
MIDI.loadPlugin(function () {
    player = MIDI.Player;
})

var playstop = function(either){
	if (either==0){
		MIDI.Player.resume();
	}
	else if (either==1){
		MIDI.Player.stop();
	}
}

var myMidi;

function readMidi(evt) {
	
	var files = document.getElementById('files').files;
	if (!files.length) {
	      alert('Please select a file!');
	      return;
	}
	
	var file = files[0];
	var reader = new FileReader();
	
	var blob = file.slice(0, file.size-1)
	reader.readAsBinaryString(blob);
	
	reader.onloadend = function(evt) {
		if (evt.target.readyState == FileReader.DONE) {
			
			var midiString = String(evt.target.result);
			player.loadFile(midiString,player.start);
			myMidi = MidiFile(midiString);
			console.log("midifile object looks like this");
			console.dir(myMidi);
			console.dir(player);
		}
	}
}

var albumArt;
var albumArtName;

function readAlbumArt(evt) {
	
	var files = document.getElementById('albumArt').files;
	if (!files.length) {
	      alert('Please select a file!');
	      return;
	}
	
	var file = files[0];
	var reader = new FileReader();
	reader.readAsBinaryString(file);

	reader.onloadend = function(evt) {
		if (evt.target.readyState == FileReader.DONE) {	
			albumArt = evt.target.result;
			albumArtName = file.name;
		}
	}
}

function upload(){
	var data = 
	{
		'title': document.getElementById('title').value,
		'artist': document.getElementById('artist').value,
		'owner': document.getElementById('owner').value,
		'playtime': player.endTime,
		'description': document.getElementById('description').value,
		'MidiFile': myMidi,
		'albumArt': albumArt,
		'albumArtName': albumArtName
	}
	uploadSocket.emit('saveMidiFile');
	uploadSocket.on('startSave', function () {
		uploadSocket.emit('midiData',data);
	});
}

document.getElementById('files').addEventListener('change', readMidi, false);
document.getElementById('albumArt').addEventListener('change', readAlbumArt, false);
</script>

</body>
</html>
