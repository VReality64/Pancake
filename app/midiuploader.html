<!DOCTYPE html>
<html>
<head>
	<meta charset="US-ASCII">
	<title>MIDI uploader</title>
    <script src="lib/midi/inc/jasmid/stream.js"></script>
    <script src="lib/midi/inc/jasmid/midifile.js"></script>
    <script src="lib/midi/inc/jasmid/replayer.js"></script>
    <script src="lib/midi/inc/Base64.js"></script>
    <script src="lib/midi/inc/base64binary.js"></script>
    <script src="lib/midi/js/MIDI/AudioDetect.js"></script>
    <script src="lib/midi/js/MIDI/LoadPlugin.js"></script>
    <script src="lib/midi/js/MIDI/Player.js"></script>
    <script src="lib/midi/js/MIDI/Plugin.js"></script>
    <script src="lib/midi/js/Window/DOMLoader.script.js"></script>
    <script src="lib/midi/js/Window/DOMLoader.XMLHttp.js"></script>
    <script src="lib/midi/js/Window/Event.js"></script>
    <link rel="stylesheet" href="midiuploader.css" />
<body>

<div class="player" style="height: 42px; box-shadow: 0 -1px #000; margin-bottom: 0; border-bottom-right-radius: 0; border-bottom-left-radius: 0;">
<div class="time-controls" style="float: left; margin: 0; position: relative; top: 5px;">
	<span id="time1" class="time">0:00</span>
	<span id="capsule">
		<span id="cursor"></span>
	</span>
	<span id="time2" class="time" style="text-align: left;">-0:00</span>
</div>
</div>

midi file  <input type="file" id="files" name="file" placeholder="midi file"></input>
<button id="play" onclick="playstop(0);">Play</button>
<button id="stop" onclick="playstop(1);">Stop</button><br>
title  <input type="text" id="title" name="title"><br>
artist  <input type="text" id="artist" name="artist"><br>
owner  <input type="text" id="owner" name="owner"></br>
album art  <input type="file" id="albumArt" name="albumArt"><br>
description <input type="text" id="description" name="description"></br>
<button id="upload" onclick="upload();">Upload</button>
<!-- TODO -->
<!--<script src="/lib/socket.io.js"> </script>-->
<script>

//setting up socket
/*var uploadSocket = io.connect('http://www.soundpancake.io');

uploadSocket.on('connect', function () {
	console.log('Connected !');
})*/

//setting up player
var player;
MIDI.loadPlugin(function () {
    player = MIDI.Player;
    MIDIPlayerPercentage(player);
})

var playstop = function(either){
	if (either==0){
		MIDI.Player.resume();
	}
	else if (either==1){
		MIDI.Player.stop();
	}
}

var myMidi;

function readMidi(evt) {
	
	var files = document.getElementById('files').files;
	if (!files.length) {
	      alert('Please select a file!');
	      return;
	}
	
	var file = files[0];
	var reader = new FileReader();
	
	var blob = file.slice(0, file.size-1)
	reader.readAsBinaryString(blob);
	
	reader.onloadend = function(evt) {
		if (evt.target.readyState == FileReader.DONE) {
			
			var midiString = String(evt.target.result);
			player.loadFile(midiString,player.start);
			myMidi = MidiFile(midiString);
			console.log("midifile object looks like this");
			console.dir(myMidi);
			console.dir(player);
		}
	}
}

var albumArt;
var albumArtName;

function readAlbumArt(evt) {
	
	var files = document.getElementById('albumArt').files;
	if (!files.length) {
	      alert('Please select a file!');
	      return;
	}
	
	var file = files[0];
	var reader = new FileReader();
	reader.readAsBinaryString(file);

	reader.onloadend = function(evt) {
		if (evt.target.readyState == FileReader.DONE) {	
			albumArt = evt.target.result;
			albumArtName = file.name;
		}
	}
}

function upload(){
	var data = 
	{
		'title': document.getElementById('title').value,
		'artist': document.getElementById('artist').value,
		'owner': document.getElementById('owner').value,
		'playtime': player.endTime,
		'description': document.getElementById('description').value,
		'MidiFile': myMidi,
		'albumArt': albumArt,
		'albumArtName': albumArtName
	}
	uploadSocket.emit('saveMidiFile');
	uploadSocket.on('startSave', function () {
		uploadSocket.emit('midiData',data);
	});
}

document.getElementById('files').addEventListener('change', readMidi, false);
document.getElementById('albumArt').addEventListener('change', readAlbumArt, false);

var MIDIPlayerPercentage = function(player) {
        // update the timestamp
        var time1 = document.getElementById("time1");
        var time2 = document.getElementById("time2");
        var capsule = document.getElementById("capsule");
        var timeCursor = document.getElementById("cursor");
        //
        Event.add(capsule, "drag", function (event, self) {
                Event.cancel(event);
                player.currentTime = (self.x) / 420 * player.endTime;
                if (player.currentTime < 0) player.currentTime = 0;
                if (player.currentTime > player.endTime) player.currentTime = player.endTime;
                if (self.state === "down") {
                        player.pause(true);
                } else if (self.state === "up") {
                        player.resume();
                }
        });
        //
        function timeFormatting(n) {
                var minutes = n / 60 >> 0; 
                var seconds = String(n - (minutes * 60) >> 0);
                if (seconds.length == 1) seconds = "0" + seconds;
                return minutes + ":" + seconds;
        };
        player.getNextSong = function(n) {
                var id = Math.abs((songid += n) % song.length);
                player.loadFile(song[id], player.start); // load MIDI
        };
        player.setAnimation(function(data, element) {
                var percent = data.now / data.end;
                var now = data.now >> 0; // where we are now
                var end = data.end >> 0; // end of song
                if (now === end) { // go to next song
                        player.stop();
                }
                // display the information to the user
                timeCursor.style.width = (percent * 100) + "%";
                time1.innerHTML = timeFormatting(now);
                time2.innerHTML = "-" + timeFormatting(end - now);
        });
};

</script>

</body>
</html>
